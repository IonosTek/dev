<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IonosTek Monitor V91.0 (NVIS Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS V91.0 (NVIS Update) --- */
        :root { 
            --bg: #0b0b0b; --card: #161616; --text: #f0f0f0; 
            --green: #00e676; --yellow: #ffea00; --orange: #ff9100; 
            --red: #ff1744; --blue: #2979ff; --purple: #d500f9;
        }
        body { 
            font-family: 'Chakra Petch', sans-serif; 
            background: var(--bg); color: var(--text); 
            margin: 0; padding: 0; user-select: none; 
        }
        
        /* Nav */
        .ionos-nav {
            background-color: #000; border-bottom: 1px solid #333;
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9em;
        }
        .nav-brand { color: var(--green); text-decoration: none; font-weight: bold; letter-spacing: 1px; }
        .nav-brand span { color: var(--purple); font-size: 0.8em; margin-left: 5px; }
        .nav-links a { color: #888; text-decoration: none; font-weight: 600; margin-left: 15px; transition: 0.3s; }
        .nav-links a:hover { color: #fff; }

        .container { padding: 15px; max-width: 1600px; margin: 0 auto; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; flex-wrap: wrap; }
        h1 { margin: 0; font-weight: 700; font-size: 1.8em; letter-spacing: 1px; }
        
        .clock-box { text-align: right; }
        .utc-time { font-size: 1.6em; font-weight: 700; color: var(--blue); line-height: 1; }
        .local-time { font-size: 0.85em; color: #888; margin-top: 4px; font-weight: 500; }
        
        /* NVIS Advisor Box */
        .nvis-advisor {
            background: linear-gradient(45deg, #1a1a1a, #222);
            border: 1px solid #444; border-left: 4px solid var(--purple);
            border-radius: 6px; padding: 15px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .nvis-left { flex: 1; }
        .nvis-title { color: var(--purple); font-weight: 800; font-size: 1.1em; margin-bottom: 5px; }
        .nvis-rec { font-size: 1.4em; font-weight: 700; color: #fff; }
        .nvis-desc { color: #aaa; font-size: 0.9em; margin-top: 2px; }
        .nvis-right { text-align: right; background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 4px; border: 1px solid #333; }
        .nvis-fof2 { font-size: 0.9em; color: #888; }
        .nvis-val { font-size: 1.2em; font-weight: bold; color: var(--green); }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .box { background: var(--card); padding: 10px; border-radius: 6px; text-align: center; border-top: 3px solid #444; }
        .val { font-size: 1.8em; font-weight: 700; margin: 5px 0; color: #fff; }
        .lbl { font-size: 0.75em; font-weight: 600; color: #888; text-transform: uppercase; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .card { background: var(--card); border-radius: 8px; border: 1px solid #333; overflow: hidden; }
        .c-head { background: #202020; padding: 8px 15px; font-size: 0.85em; color: #ccc; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .c-body { background: #000; height: 250px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .c-body img { width: 100%; height: 100%; object-fit: contain; cursor: pointer; transition: opacity 0.3s; }
        
        /* Utility */
        .c-norm { border-top-color: var(--green) !important; color: var(--green); }
        .c-warn { border-top-color: var(--yellow) !important; color: var(--yellow); }
        .c-alert { border-top-color: var(--red) !important; color: var(--red); }
        .trend-up { color: var(--green); font-size: 0.7em; vertical-align: middle; }
        .trend-down { color: var(--red); font-size: 0.7em; vertical-align: middle; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; align-items: center; justify-content: center; }
        .m-content { background: var(--card); padding: 30px; border-radius: 10px; max-width: 600px; border: 1px solid #444; position: relative; }
        .close { position: absolute; top: 10px; right: 20px; font-size: 30px; cursor: pointer; color: #fff; }
        #lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 1000; align-items: center; justify-content: center; }
        #lightbox img { max-width: 98%; max-height: 95vh; border: 2px solid #333; }

        .footer { margin-top: 30px; border-top: 1px solid #333; padding-top: 15px; color: #555; font-size: 0.8em; display: flex; justify-content: space-between; }
        .btn-retry { background: #333; color: #ccc; border: 1px solid #555; padding: 2px 8px; cursor: pointer; }

        @media (max-width: 600px) { 
            .header { flex-direction: column; text-align: center; gap:10px; } 
            .nvis-advisor { flex-direction: column; text-align: center; gap: 10px; }
            .nvis-right { width: 100%; box-sizing: border-box; }
        }
    </style>
</head>
<body>
    <nav class="ionos-nav">
        <a href="#" class="nav-brand">> IONOSTEK <span>NVIS</span></a>
        <div class="nav-links">
            <a href="javascript:location.reload()">REFRESH</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <div>
                <h1>IONOSTEK <span style="color:#666">MONITOR</span></h1>
                <div style="font-size:0.8em; color:#888;">Real-Time HF & NVIS Propagation System</div>
            </div>
            <div class="clock-box">
                <div class="utc-time"><span id="u-h">00</span>:<span id="u-m">00</span> UTC</div>
                <div class="local-time" id="local-clock">--:-- Local</div>
            </div>
        </div>

        <div class="nvis-advisor">
            <div class="nvis-left">
                <div class="nvis-title">⚡ LOCAL CONTACT ADVISOR (0-500KM)</div>
                <div class="nvis-rec" id="nvis-rec-band">CALCULATING...</div>
                <div class="nvis-desc" id="nvis-desc-text">Analysis based on Solar Angle & SFI</div>
            </div>
            <div class="nvis-right">
                <div class="nvis-fof2">Est. Critical Freq (foF2)</div>
                <div class="nvis-val" id="est-fof2">-- MHz</div>
            </div>
        </div>

        <div class="stats">
            <div class="box" id="b-sfi"><div class="lbl">SFI</div><div class="val" id="v-sfi">--</div></div>
            <div class="box" id="b-ssn"><div class="lbl">SSN</div><div class="val" id="v-ssn">--</div></div>
            <div class="box" id="b-kp"><div class="lbl">Kp Index</div><div class="val" id="v-kp">--</div></div>
            <div class="box" id="b-bz"><div class="lbl">Bz (nT)</div><div class="val" id="v-bz">--</div></div>
            <div class="box" id="b-wind"><div class="lbl">Wind</div><div class="val" id="v-wind">--</div></div>
        </div>

        <div class="grid">
            <div class="card" style="border-color: var(--purple);">
                <div class="c-head"><span style="color:var(--purple); font-weight:bold;">★ GLOBAL foF2 (NVIS MAP)</span> <span>SWS/AU</span></div>
                <div class="c-body">
                    <img src="https://www.sws.bom.gov.au/Images/HF%20Systems/Global%20HF/Ionospheric%20Map/Global%20Ionospheric%20Map.gif" 
                         referrerpolicy="no-referrer" onclick="view(this.src)" 
                         onerror="this.src='https://placehold.co/600x400?text=Map+Unavailable';">
                </div>
            </div>
            
            <div class="card">
                <div class="c-head"><span>D-REGION ABSORPTION (D-RAP)</span> <span>NOAA</span></div>
                <div class="c-body"><img src="https://services.swpc.noaa.gov/images/animations/d-rap/global/d-rap/latest.png" onclick="view(this.src)"></div>
            </div>

            <div class="card">
                <div class="c-head"><span>SUNSPOTS (SDO/HMI)</span> <span>NASA</span></div>
                <div class="c-body"><img src="https://sdo.gsfc.nasa.gov/assets/img/latest/latest_1024_HMIIC.jpg" onclick="view(this.src)"></div>
            </div>

            <div class="card">
                <div class="c-head"><span>TEC (PROPAGATION)</span> <span>SWPC</span></div>
                <div class="c-body"><img src="https://services.swpc.noaa.gov/images/animations/ctipe/tec/latest.png" onclick="view(this.src)"></div>
            </div>
        </div>

        <div id="lightbox" onclick="this.style.display='none'"><img id="lb-img"></div>

        <div class="footer">
            <span id="sys-log">System Ready</span>
            <span>V91.0 • NVIS Turbo • <button class="btn-retry" onclick="updateData()">Update</button></span>
        </div>
    </div>

    <script>
        // --- LOGIC ---
        function view(src) { 
            document.getElementById('lb-img').src = src + '?t=' + new Date().getTime(); // Prevent Cache
            document.getElementById('lightbox').style.display = 'flex'; 
        }
        function log(msg) { document.getElementById('sys-log').innerText = msg; }

        function updateClock() {
            const d = new Date();
            document.getElementById('u-h').innerText = d.getUTCHours().toString().padStart(2,'0');
            document.getElementById('u-m').innerText = d.getUTCMinutes().toString().padStart(2,'0');
            
            const localH = d.getHours();
            const localM = d.getMinutes().toString().padStart(2,'0');
            document.getElementById('local-clock').innerText = `${localH}:${localM} Local`;
            
            return localH; // Return hour for Day/Night logic
        }

        // --- NVIS CALCULATOR ---
        function updateNVIS(sfi, kp, localHour) {
            let band = "--";
            let desc = "Standby...";
            let fof2Est = 0;
            let statusColor = "#fff";

            // 1. Estimate base foF2 from SFI (Rough Heuristic)
            // SFI 70 ~ 4MHz, SFI 150 ~ 8-9MHz
            let baseFoF2 = 3.0 + (sfi - 60) * 0.05; 
            if(baseFoF2 < 3) baseFoF2 = 3;

            // 2. Adjust for Day/Night (Diurnal Variation)
            // Day (06-18): Higher foF2 | Night: Lower foF2 (drop by ~40-50%)
            let isDay = (localHour >= 6 && localHour < 18);
            
            if (isDay) {
                // Daytime logic
                fof2Est = baseFoF2; 
                // Kp Storm Effect: High Kp depresses foF2
                if (kp >= 4) fof2Est *= 0.8;
                if (kp >= 6) fof2Est *= 0.6;

                // Recommendation
                if (fof2Est >= 6.5) {
                    band = "40m (7 MHz)";
                    desc = "Good Condition. Signals Strong.";
                    statusColor = "var(--green)";
                } else if (fof2Est >= 5) {
                    band = "40m Weak / 80m Good";
                    desc = "40m might be long skip only.";
                    statusColor = "var(--yellow)";
                } else {
                    band = "80m (3.5 MHz)";
                    desc = "Poor Solar Flux. Use lower bands.";
                    statusColor = "var(--orange)";
                }
            } else {
                // Nighttime logic
                fof2Est = baseFoF2 * 0.55; // Night drop
                
                if (fof2Est >= 3.5) {
                    band = "80m (3.5 MHz)";
                    desc = "Normal Night NVIS.";
                    statusColor = "var(--green)";
                } else if (fof2Est >= 1.8) {
                    band = "160m (1.8 MHz)";
                    desc = "foF2 too low for 80m. Use 160m.";
                    statusColor = "var(--red)";
                } else {
                    band = "No NVIS";
                    desc = "Critical Freq below 1.8MHz.";
                    statusColor = "#888";
                }
            }
            
            // 3. Update UI
            document.getElementById('nvis-rec-band').innerText = band;
            document.getElementById('nvis-rec-band').style.color = statusColor;
            document.getElementById('nvis-desc-text').innerText = desc;
            document.getElementById('est-fof2').innerText = "~" + fof2Est.toFixed(1) + " MHz";
        }

        // --- FETCH DATA ---
        async function fetchJSON(url) {
            try {
                // Try CORS Proxy first for speed/compatibility
                let r = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                if(r.ok) return await r.json();
            } catch(e) {}
            return null;
        }

        async function updateData() {
            log('Fetching Data...');
            
            // 1. NOAA Solar Indices
            let sfi = 0, ssn = 0;
            try {
                let txt = await (await fetch('https://services.swpc.noaa.gov/text/daily-solar-indices.txt')).text();
                let lines = txt.trim().split('\n');
                let lastLine = lines[lines.length-1].trim().split(/\s+/);
                sfi = parseInt(lastLine[3]);
                ssn = parseInt(lastLine[4]);
                
                document.getElementById('v-sfi').innerText = sfi;
                document.getElementById('v-ssn').innerText = ssn;
                // Color Logic
                document.getElementById('b-sfi').className = 'box ' + (sfi>100 ? 'c-norm' : 'c-warn');
            } catch(e) {}

            // 2. Kp Index (Realtime)
            let kp = 0;
            let kpData = await fetchJSON('https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json');
            if(kpData) {
                let last = kpData[kpData.length-1];
                kp = parseFloat(last[1]);
                document.getElementById('v-kp').innerText = kp;
                document.getElementById('b-kp').className = 'box ' + (kp<4 ? 'c-norm' : 'c-alert');
            }

            // 3. Solar Wind (Bz/Wind)
            let magData = await fetchJSON('https://services.swpc.noaa.gov/products/solar-wind/mag-2-hour.json');
            if(magData) {
                let bz = parseFloat(magData[magData.length-1][3]);
                document.getElementById('v-bz').innerText = bz;
                // Bz Logic: Negative is Bad (Open Switch)
                document.getElementById('b-bz').className = 'box ' + (bz>=0 ? 'c-norm' : 'c-alert');
            }
            
            let plasData = await fetchJSON('https://services.swpc.noaa.gov/products/solar-wind/plasma-2-hour.json');
            if(plasData) {
                let wind = Math.round(parseFloat(plasData[plasData.length-1][2]));
                document.getElementById('v-wind').innerText = wind;
            }

            // 4. Run NVIS Logic
            let currentHour = updateClock();
            updateNVIS(sfi, kp, currentHour);
            
            log('System Active');
        }

        // --- INIT ---
        setInterval(updateClock, 1000);
        updateData();
        setInterval(updateData, 60000); // Auto-refresh every 1 min
    </script>
</body>
</html>
